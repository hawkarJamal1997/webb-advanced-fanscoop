<!DOCTYPE html>
<html lang="en">
<head>
	<meta charset="UTF-8">
	<meta http-equiv="X-UA-Compatible" content="IE=edge">
	<meta name="viewport" content="width=device-width, initial-scale=1.0">
	 <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bulma@0.9.0/css/bulma.min.css">
    <link rel="stylesheet" href="/css/layout.css">
	<title>My Site</title>
	
	<style>
		
		/*** TODO: Put CSS code in separate file. ***/
		
		/* Code for only showing the page with the class "current-page". */
		main > .page{
			display: none;
		}
		
		main > .page.current-page{
			display: block;
		}
		
		/* Code for hiding elements depending on if the user is logged in or not. */
		.is-logged-in .if-is-logged-out{
			display: none;
		}
		
		.is-logged-out .if-is-logged-in{
			display: none;
		}
		
	</style>
	
	<script src="Http-helper.js"></script>
	<script>
		/*** TODO: Writing all code in a single file like this is not good. ***/
		// Especially, writing a library/SDK to only handle the communication with
		// the backend is a very good idea.
				
		// TODO: Want to remember the access token across page reloads?
		// You could for example store it in local storage, although that
		// would be really bad if your website contains a XSS vulnerability.
		let accessToken = ""
		
		document.addEventListener("DOMContentLoaded", function(){
			
			showPage(location.pathname)
			
			// TODO: Write comment explaining why we listen for click on links
			// this very strange way.
			document.body.addEventListener("click", function(event){
				
				const clickedElement = event.target
				
				if(clickedElement.tagName == "A"){
					
					if(clickedElement.hostname == location.hostname){
						
						event.preventDefault()
						
						const uri = clickedElement.getAttribute("href")
						
						if(location.pathname != uri){
							
							hideCurrentPage()
							showPage(uri)
							
							history.pushState({}, "", uri)
							
						}
						
					}
					
				}
				
			})
			
			document.getElementById("login-form").addEventListener("submit", async function(event){
				
				event.preventDefault()
				
				const username = document.getElementById("username").value
				const password = document.getElementById("password").value
				
				// TODO: Can add client-side validation here.
				
				const data = {
					username,
					password,
					grant_type: "password"
				}
				
				const response = await fetch(BACKEND_URI+"tokens", {
					method: "POST",
					headers: {
						"Content-Type": "application/x-www-form-urlencoded"
					},
					body: new URLSearchParams(data)
				})
				
				switch(response.status){
					
					case 200:
						
						const body = await response.json()
						
						accessToken = body.access_token
						
						document.body.classList.remove("is-logged-out")
						document.body.classList.add("is-logged-in")
						
						// TODO: Show feedback to the user (did the login succeed?).
						
					break
					case 400:
						
						// TODO.
						
					break
					case 500:
					default:
						
						// TODO.
					
				}
				
			})
			
			document.getElementById("create-post-form").addEventListener("submit", async function(event){
				
				event.preventDefault()
				
				const name = document.getElementById("name").value
				const age = document.getElementById("age").value
				
				// TODO: Can add client-side validation here.
				
				const post = {
					name,
					age
				}
				
				// TODO: Here we can start showing a loading indicator.
				const response = await fetch(BACKEND_URI+"posts", {
					method: "POST",
					headers: {
						"Content-Type": "application/json",
						"Authorization": "Bearer "+accessToken
					},
					body: JSON.stringify(post)
				})
				// TODO: And here we can stop showing a loading indicator.
				
				switch(response.status){
					
					case 201:
						
						const createdpost = await response.json()
						
						const uri = "/posts/"+createdpost.id
						
						// TODO: This is the same code that runs when clicking on a link. Function instead of code duplication?
						history.pushState({}, "", uri)
						hideCurrentPage()
						showPage(uri)
						
					break
					case 400:
						// TODO.
					break
					case 500:
					default:
						// TODDO.
				}
				
			})
			
		})
		
		window.addEventListener("popstate", function(event){
			
			const uri = location.pathname
			hideCurrentPage()
			showPage(uri)
			
		})
		
		function showPage(uri){
			
			let newPageId = ""
			
			switch(uri){
				
				case "/":
					newPageId = "home-page"
					break
				case "/about":
					newPageId = "about-page"
					break
				case "/login":
					newPageId = "login-page"
					break
				case "/clubs":
					newPageId = "clubs-page"
					loadAllClubs()
					break
				case "/posts":
					newPageId = "posts-page"
					loadAllPosts()
					break
				case "/create-post":
					newPageId = "create-post-page"
					break
				default:
					
					if(uri.startsWith("/posts/")){
						newPageId = "post-page"
						const postId = uri.split("/")[2]
						loadPostPage(postId)
					}else{
						newPageId = "not-found-page"
					}
				
			}
			
			document.getElementById(newPageId).classList.add("current-page")
			
		}
		
		function hideCurrentPage(){
			document.querySelector(".current-page").classList.remove("current-page")
		}

		async function loadAllClubs(){

			const page = document.getElementById("clubs-page")
			page.innerText = ""
			
			const h1 = document.createElement("h1")
			h1.innerText = "All Clubs"
			page.appendChild(h1)
			
			// TODO: Investigate how the code works when the backend is down.
			try {
				const data = await Get("api/clubs")
				if(data.errors) {
					for(const error of errors) {
						const p = document.createElement("p")
						p.innerText = error
						page.appendChild(p)
					}
					return;
				}

				const clubs = data.clubs
					
				const ul = document.createElement("ul")
				
				for(const club of clubs){
					const li = document.createElement("li")
					const a = document.createElement("a")
					a.innerText = club.name
					a.setAttribute("href", "/club/"+club.id)
					li.appendChild(a)
					ul.appendChild(li)
				}
					
				page.appendChild(ul)
			} catch (error) {
				console.error("error ", error)
			}
			/*
			await fetch(BACKEND_URI+"api/clubs")
			.then((res) => res.json())
			.then( (data) => {
				console.log("data: ", data)
			})
			.catch( (error) => {
				console.error("error: ", error)
			})		
			switch(response.status){
				
				case 200:
					
					const clubs = await response.then((response) => response.json()).then((data) => )
					
					const ul = document.createElement("ul")
					
					for(const club of clubs){
						const li = document.createElement("li")
						const a = document.createElement("a")
						a.innerText = club.name
						a.setAttribute("href", "/club/"+club.id)
						li.appendChild(a)
						ul.appendChild(li)
					}
					
					page.appendChild(ul)
					
				break
				
				case 500:
				default:
					// TODO
				
			}*/
		}
		
		async function loadAllPosts(){
			
			const page = document.getElementById("all-posts-page")
			page.innerText = ""
			
			const h1 = document.createElement("h1")
			h1.innerText = "All posts"
			page.appendChild(h1)
			
			// TODO: Investigate how the code works when the backend is down.
			const response = await fetch(BACKEND_URI+"postsApi/milan")
			
			switch(response.status){
				
				case 200:
					
					const posts = await response.json()
					
					const ul = document.createElement("ul")
					
					for(const post of posts){
						const li = document.createElement("li")
						const a = document.createElement("a")
						a.innerText = post.name
						a.setAttribute("href", "/posts/"+post.id)
						li.appendChild(a)
						ul.appendChild(li)
					}
					
					page.appendChild(ul)
					
				break
				
				case 500:
				default:
					// TODO
				
			}
			
		}
		
		async function loadPostPage(postId){
			
			const page = document.getElementById("post-page")
			page.innerText = ""
			
			const h1 = document.createElement("h1")
			h1.innerText = "post"
			page.appendChild(h1)
			
			const response = await fetch(BACKEND_URI+"posts/"+postId)
			
			switch(response.status){
				
				case 200:
					
					const post = await response.json()
					
					const p = document.createElement("p")
					p.innerText = post.name+" is "+post.age+" years old."
					
					page.appendChild(p)
					
				break
				
				case 404:
					// TODO
				break
				
				case 500:
				default:
					// TODO
				
			}
			
		}
		
	</script>
	
</head>
<body class="is-logged-out">
	
	<nav class="navbar is-info" role="navigation" aria-label="main navigation">
        <div class="navbar-brand">
            <a class="navbar-item" href="/"><strong>FanScoop</strong></a>
            <a role="button" class="navbar-burger burger" onclick="document.querySelector('.navbar-menu').classList.toggle('is-active');" aria-label="menu" aria-expanded="false" data-target="navbarBasicExample">
                <span aria-hidden="true"></span>
                <span aria-hidden="true"></span>
                <span aria-hidden="true"></span>
                </a>
        </div>
        <div class="navbar-menu">
            <div class="navbar-start">
                <a href="/accounts" class="navbar-item">Accounts</a>
                <a href="/clubs" class="navbar-item">Clubs</a>
                <a href="/about" class="navbar-item">About</a>
            </div>
            <div class="navbar-end">
                <div class="navbar-item">
                    <div class="buttons">
                            <form action="/accounts/logout" method="POST">
                                <input class="button is-success" type="submit" value="Logout">
                            </form>
                        <a href="/accounts/sign-up" class="button is-dark">Sign up</a>
                        <a href="/accounts/sign-in" class="button is-light">Sign in</a>
                      
                    </div>
                </div>
            </div>
        </div>
    </nav>
	
	<main>
		
		<div class="page" id="home-page">
			<h1>Home</h1>
			<p>Welcome to this site!</p>
			<p>Go to <a href="/about">About page</a>.</p>
		</div>
		
		<div class="page" id="about-page">
			<h1>About</h1>
			<p>The about page...</p>
			<p>Read about <a href="http://nintendo.se">Nintendo</a>.</p>
		</div>

		<div class="page" id="clubs-page">
			<h1>About</h1>
			<p>The about page...</p>
			<p>Read about <a href="http://nintendo.se">Nintendo</a>.</p>
		</div>
		
		<div class="page" id="create-post-page">
			<h1>Create</h1>
			<form action="" id="create-post-form">
				<div>
					Name: <input type="text" id="name">
				</div>
				<div>
					Age: <input type="number" id="age">
				</div>
				<input type="submit" value="Create">
			</form>
		</div>
		
		<div class="page" id="login-page">
			<h1>Login</h1>
			<form action="" id="login-form">
				<div>
					Username: <input type="text" id="username">
				</div>
				<div>
					Password: <input type="password" id="password">
				</div>
				<input type="submit" value="Login">
			</form>
		</div>
		
		<div class="page" id="all-posts-page"></div>
		
		<div class="page" id="post-page"></div>
		
		<div class="page" id="not-found-page">
			<h1>Not Found</h1>
		</div>
		
	</main>
	
</body>
</html>